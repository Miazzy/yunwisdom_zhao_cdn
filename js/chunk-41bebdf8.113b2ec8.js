(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-41bebdf8","chunk-41bebdf8"],{"009f":function(t,e,i){"use strict";i.r(e);var s=i("57e0"),n=i("28ba"),o=(i("e37d"),i("2877")),a=Object(o["a"])(n["a"],s["a"],s["b"],!1,null,null,null);e["default"]=a.exports},d077:function(t,e,i){},d7d2:function(t,e,i){"use strict";i("8e6e"),i("456d"),i("a481"),i("4917"),i("ac6a"),i("7f7f"),i("20d6");var s=i("bd86"),n=(i("c5f6"),i("5880")),o=i("a532"),a=i("b199"),r=i("8870"),c=i("d8bc"),d=i("f66c"),l=i("4540"),h=i("e8d3"),u=i("d3a1"),m=i("68fe"),k=i("2f14"),f=i("97a8"),g=i("81fe"),T=i("ca8d"),b=i("261e"),v=i("cff3");function p(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,s)}return i}function w(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?p(Object(i),!0).forEach((function(e){Object(s["a"])(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):p(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var M=Object(m["a"])("tokenList",!0),L="";if(M){var j=M.accessToken,C=M.tokenType;L="".concat(C," ").concat(j)}e["a"]={name:"task-detail",components:{ATextarea:b["a"],editor:o["default"],taskMemberMenu:d["default"],taskTagMenu:l["default"],projectMemberMenu:h["default"],inviteProjectMember:u["default"]},props:{taskCode:{type:[String],default:function(){return""}},width:{type:[String,Number],default:function(){return"1200"}}},data:function(){return{moment:moment,loading:!1,code:this.taskCode,projectCodeCurrent:"",task:{},taskLogList:[],taskLogTotal:0,taskMemberList:[],workTimeList:[],workTimeTotal:[],visibleTaskMenu:!1,visibleTaskMemberMenu:!1,visibleTaskTagMenu:!1,visibleProjectMemberMenu:!1,showInviteMember:!1,taskName:"",showEditName:!1,showBeginTime:!1,showEndTime:!1,showTaskDescriptionEdit:!1,showMoreDesc:!1,hasMoreDesc:!1,editorConfig:{uploadImgServer:Object(k["c"])("project/index/uploadImg"),uploadImgHeaders:{Authorization:L},menus:["head","bold","italic","justify","image","link","list","quote","table","|","fullscreen"]},departmentMemberInfo:null,childTaskList:[],showChildTask:!1,childTaskName:"",childExecutor:null,visibleChildTaskMemberMenu:!1,showInviteChildTaskMember:!1,taskSourceList:[],taskLogType:["all"],showMoreTaskLog:0,hasMoreTaskLog:!1,hideShowMore:!1,comment:"",commenting:!1,workTimeDo:{form:this.$form.createForm(this),info:null,modalTitle:"登记工时记录",modalStatus:!1,confirmLoading:!1},plainWorkTime:{form:this.$form.createForm(this),modalTitle:"设置预估工时",modalStatus:!1,confirmLoading:!1},showMentions:!1,mentionsList:[]}},computed:w({},Object(n["mapState"])({userInfo:function(t){return t.userInfo},uploader:function(t){return t.common.uploader},socketAction:function(t){return t.socketAction}}),{childTaskDoneNum:function(){var t=this.childTaskList.filter((function(t){return 1==t.done}));return t.length},checkShowMoreLog:function(){return!this.hideShowMore&&this.taskLogTotal>5},taskLink:function(){return window.location.href},scrollOps:function(){return{rail:{background:"#e5e5e5",opacity:1},bar:{keepShow:!0}}}}),watch:{$route:function(t,e){},showInviteMember:function(t){t||this.getTaskMembers()},taskLogType:function(){this.getTaskLog()},socketAction:function(t){if("organization:task"===t.action){var e=t.data.data;e.taskCode==this.code&&this.init(null,!1)}},uploader:{handler:function(t,e){var i=this;console.log(t),console.log(t.fileList);var s=t.fileList,n=s.findIndex((function(t){return t.projectName==i.task.projectName}));-1!==n&&(this.taskSources(),this.getTaskLog())},deep:!0}},created:function(){this.init()},mounted:function(){var t=this,e=arguments;this.changeModalHeight(),window.onresize=function(){return function(){t.changeModalHeight()}()},document.onkeydown=function(i){console.log(i);var s=i||window.event||e.callee.caller.arguments[0];13==s.keyCode&&s.ctrlKey&&t.createComment(),"@"==s.key&&t.commenting?t.showMentions=!0:t.showMentions=!1},setTimeout((function(){t.uploader.assignBrowse(document.getElementById("upload-file"))}),500)},filters:{formatLogTime:function(t){return Object(g["c"])(t)}},methods:{init:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];t&&(this.code=t),e&&(this.loading=!0),this.clearMemberMenu(),this.getTask(),this.getChildTasks(),this.getTaskMembers(),this.getTaskWorkTimeList()},detailClose:function(){this.$emit("close",this.task)},clearMemberMenu:function(){this.visibleTaskTagMenu=!1,this.visibleTaskMemberMenu=!1,this.visibleProjectMemberMenu=!1},getTask:function(){var t=this;this.$store.commit("viewRefresh"),this.clearMemberMenu(),Object(a["g"])(this.code).then((function(e){t.getTaskLog(),t.taskSources(),t.taskName=e.data.name,t.task=e.data,t.projectCodeCurrent=e.data.project_code,t.task.end_time?(t.task.setEndTime=!0,t.task.end_time=moment(t.task.end_time)):(t.task.setEndTime=!1,t.task.end_time=moment(moment().format("YYYY-MM-DD")+" 18:00")),t.task.end_time_format=Object(g["b"])(t.task.end_time,!0),t.task.begin_time?(t.task.setBeginTime=!0,t.task.begin_time=moment(t.task.begin_time)):(t.task.setBeginTime=!1,t.task.begin_time=moment(moment().format("YYYY-MM-DD")+" 18:00")),t.task.begin_time_format=Object(g["b"])(t.task.begin_time,!0),t.initContent(t.task.description),t.task.executor&&!t.childExecutor&&(t.childExecutor=t.task.executor),t.loading=!1,t.$store.dispatch("setTempData",{projectCode:t.projectCodeCurrent,taskCode:t.code,projectName:e.data.projectName})}))},getTaskLog:function(){var t=this;Object(a["f"])({taskCode:this.code,all:this.showMoreTaskLog,pageSize:5,comment:"comment"==this.taskLogType[0]?1:0}).then((function(e){t.taskLogList=e.data.list,t.taskLogTotal=e.data.total,e.data.total>5&&(t.hasMoreTaskLog=!0)}))},taskSources:function(){var t=this;Object(T["t"])({taskCode:this.code}).then((function(e){t.taskSourceList=e.data}))},getMoreTaskLog:function(){this.showMoreTaskLog=1,this.hideShowMore=!0,this.getTaskLog()},getTaskWorkTimeList:function(){var t=this;Object(T["a"])({taskCode:this.code}).then((function(e){t.workTimeList=e.data;var i=0;e.data&&(e.data.forEach((function(t){i+=Number(t.num)})),t.workTimeTotal=i)}))},getTaskMembers:function(){var t=this;this.clearMemberMenu(),Object(c["b"])({taskCode:this.code,pageSize:100}).then((function(e){t.taskMemberList=e.data.list,t.loading=!1}))},doTask:function(t){var e=this,i=this,s=t.key;switch(s){case"recycle":this.$confirm({title:"移到回收站",content:"您确定要把该任务移到回收站吗？",okText:"确定",okType:"danger",cancelText:"再想想",onOk:function(){return Object(a["i"])(i.code).then((function(t){var e=Object(k["a"])(t);if(!e)return!1;i.task.deleted=1,i.getTaskLog()})),Promise.resolve()}});break;case"star":return this.task.stared?this.task.stared=0:this.task.stared=1,Object(a["k"])(i.code,this.task.stared),!0;case"open":var n=window.location.href;-1!==n.indexOf("?")?n+="&full-screen":n+="?full-screen",window.open(n);break;case"private":return Object(T["p"])(i.code,Number(!this.task.private)).then((function(t){var i=Object(k["a"])(t);if(!i)return!1;e.task.private=Number(!e.task.private)})),!0}this.visibleTaskMenu=!1},editTitle:function(){var t=this;this.showEditName=!0,this.$nextTick((function(){t.$refs.inputTitle.focus()}))},doSource:function(t,e){var i=this,s=t.key;switch(s){case"unlink":this.$confirm({title:"取消关联",content:"您确定永久删除这个关联？",okText:"确定",okType:"danger",cancelText:"再想想",onOk:function(){return Object(r["a"])(e.code).then((function(t){var e=Object(k["a"])(t);if(!e)return!1;i.taskSources(),i.getTaskLog()})),Promise.resolve()}});break;case"copy":return Object(f["b"])({title:"复制链接成功",msg:"在地址栏粘贴并打开可下载该资源"},"notice","success",5),!0}},deleteTask:function(){var t=this;this.$confirm({title:"彻底删除",content:"彻底删除任务后，该任务及其子任务将会被永久被删除。",okText:"删除",okType:"danger",cancelText:"再想想",onOk:function(){return Object(a["b"])(t.code).then((function(e){t.detailClose()})),Promise.resolve()}})},recoveryTask:function(){var t=this;this.$confirm({title:"恢复内容",content:"您确定要恢复该任务吗？",okText:"确定",okType:"primary",cancelText:"再想想",onOk:function(){return Object(a["h"])(t.code).then((function(e){var i=Object(k["a"])(e);if(!i)return!1;t.getTaskLog()})),t.task.deleted=0,Promise.resolve()}})},copyLink:function(){Object(f["b"])({title:"复制链接成功",msg:"你可以在其他标签页粘贴并快速打开任务页面"},"notice","success",5)},like:function(t){t=Number(t),Object(a["d"])(this.code,t),t?this.task.like++:this.task.like--,this.task.liked=t},taskDone:function(t,e,i){var s=this,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"self";e=e?1:0,Object(a["l"])(t,e).then((function(t){var o=Object(k["a"])(t);if(!o)return!1;s.getTaskLog(),"self"==n?s.task.done=e:s.childTaskList[i].done=e,s.getTask(),s.getChildTasks()}))},doBeginTime:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.task.setBeginTime=t,this.showBeginTime=e;var i="";t?(i=moment(this.task.begin_time).format("YYYY-MM-DD HH:mm"),this.task.begin_time_format=moment(this.task.begin_time).format("MM月DD日 HH:mm")):i="",this.editTask({begin_time:i})},doEndTime:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.task.setEndTime=t,this.showEndTime=e;var i="";t?(i=moment(this.task.end_time).format("YYYY-MM-DD HH:mm"),this.task.end_time_format=moment(this.task.end_time).format("MM月DD日 HH:mm")):i="",this.editTask({end_time:i})},doPri:function(t){this.editTask({pri:t.key})},doName:function(){if(this.showEditName=!1,!this.task.name.trim()||this.task.name==this.taskName)return this.task.name=this.taskName,!1;this.editTask({name:this.task.name})},editTask:function(t){var e=this;t.taskCode=this.code,Object(a["c"])(t).then((function(t){var i=Object(k["a"])(t);if(!i)return!1;e.getTask()}))},priColor:function(t){switch(t){case 1:return"#ff9900";case 2:return"#ed3f14";default:return"#a6a6a6"}},showTaskDesc:function(){if(this.task.deleted)return!1;this.showTaskDescriptionEdit=!0,this.initContent(this.task.description)},initContent:function(t){var e=this;t?this.$refs.vueWangeditor.setHtml(t):this.$refs.vueWangeditor.setHtml(""),this.$nextTick((function(){e.checkShowMoreDesc(!1,!0)}))},doContent:function(){var t=this,e=this.$refs.vueWangeditor.getHtml(),i={taskCode:this.code,description:e};Object(a["c"])(i).then((function(){t.task.description=e,t.showTaskDescriptionEdit=!1,t.$nextTick((function(){t.checkShowMoreDesc(!1,!0)})),t.getTaskLog()}))},createComment:function(){var t=this,e=this.comment.trim();if(!e)return!1;e+=" ";var i=/(@[^@]+) /g,s=e.match(i);s&&s.forEach((function(e){var i=e.substring(1,e.length-1);-1===t.mentionsList.findIndex((function(t){return t==i}))&&t.mentionsList.push(i)})),Object(a["a"])(this.code,this.comment,JSON.stringify(this.mentionsList)).then((function(){t.comment="",t.mentionsList=[],t.getTaskLog()}))},checkShowMoreDesc:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=$(".description-txt");if(e||(t?(this.showMoreDesc=!0,i.css("max-height",(function(){return"100%"}))):(this.showMoreDesc=!1,i.css("max-height",(function(){return"300px"})))),e){var s=i.height();return s>=300?(this.hasMoreDesc=!0,!0):(this.hasMoreDesc=!1,!1)}return!1},createTask:function(){var t=this,e={pcode:this.code,name:this.childTaskName};this.childExecutor&&(e.assign_to=this.childExecutor.code),Object(a["j"])(e).then((function(e){var i=Object(k["a"])(e);if(!i)return!1;t.childTaskName="",t.getChildTasks(),t.getTaskLog()}))},getChildTasks:function(){var t=this;Object(a["e"])({pcode:this.code,pageSize:100,deleted:0}).then((function(e){var i=[];e.data.list.forEach((function(t){t.visibleChildTaskMemberMenu=!1,i.push(t)})),t.childTaskList=i}))},taskTagChange:function(t){var e=this.task.tags.findIndex((function(e){return e.tag_code==t.code}));-1!==e?this.task.tags.splice(e,1):this.task.tags.push({tag_code:t.code,tag:t})},taskTagUpdate:function(t){var e=this.task.tags.findIndex((function(e){return e.tag_code==t.code}));-1!==e&&(this.task.tags[e].tag=t)},taskTagDelete:function(t){var e=this.task.tags.findIndex((function(e){return e.tag_code==t.code}));-1!==e&&this.task.tags.splice(e,1)},removeTag:function(t,e){var i=this;Object(T["q"])({taskCode:this.task.code,tagCode:t.code}).then((function(){i.task.tags.splice(e,1)}))},doPlainWorkTime:function(){var t=this;this.plainWorkTime.modalStatus=!0,this.$nextTick((function(){t.plainWorkTime.form.setFieldsValue({work_time:t.task.work_time})}))},doWorkTime:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=this;this.workTimeDo.modalStatus=!0,t?(this.workTimeDo.info=t,this.$nextTick((function(){e.workTimeDo.form.setFieldsValue({num:t.num,begin_time:moment(t.begin_time),content:t.content})}))):(this.workTimeDo.form.resetFields(),this.workTimeDo.info=null)},deleteWorkTime:function(t,e){var i=this;this.$confirm({title:"删除工时记录",content:"确定要删除工时记录吗？",okText:"确定",okType:"danger",cancelText:"再想想",onOk:function(){return Object(T["f"])({code:t.code}).then((function(s){Object(k["a"])(s)&&(i.workTimeList.splice(e,1),i.workTimeTotal-=t.num)})),Promise.resolve()}})},workTimePlainHandleSubmit:function(){var t=this;this.plainWorkTime.form.validateFields((function(e,i){e||(t.editTask({work_time:i.work_time}),t.plainWorkTime.modalStatus=!1)}))},workTimeHandleSubmit:function(){var t=this;this.workTimeDo.form.validateFields((function(e,i){if(!e){t.workTimeDo.confirmLoading=!0;var s={beginTime:i.begin_time.format("YYYY-MM-DD HH:mm"),num:i.num,content:i.content,taskCode:t.code};t.workTimeDo.info?(s.code=t.workTimeDo.info.code,Object(T["g"])(s).then((function(e){t.workTimeDo.confirmLoading=!1,Object(k["a"])(e)&&(t.workTimeDo.modalStatus=!1,t.getTaskWorkTimeList())}))):Object(T["n"])(s).then((function(e){t.workTimeDo.confirmLoading=!1,Object(k["a"])(e)&&(t.workTimeDo.modalStatus=!1,t.getTaskWorkTimeList())}))}}))},checkLink:function(t){var e=/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|&|-)+)/g;return e.exec(t)?(t=t.replace(e,"<a target='_blank' href='$1$2'>$1$2</a>"),t):t},updateChildExecutor:function(t){this.visibleChildTaskMemberMenu=!1,this.childExecutor=t},getPopup:function(){return document.getElementById("footer")},getTaskMemberPopup:function(){return document.getElementById("task-detail")},departmentMemberDetail:function(t){var e=this;Object(v["a"])({code:t,organization:this.$store.state.currentOrganization.code}).then((function(t){e.departmentMemberInfo=t.data}))},selectMentionMember:function(t){var e=this;this.showMentions=!1,this.comment+=t.name+" ",this.$nextTick((function(){e.$refs.commentText.focus()}))},changeModalHeight:function(){var t=this.width,e=$(window).width()-100,i=$(window).height()-150,s=$(window).height()-315;"full-screen"===t||void 0!==this.$route.query["full-screen"]?($(".task-detail-modal").css("width",$(window).width()),$(".task-detail").css("width",$(window).width()),$(".ant-modal").css("top",0),i+=85,s+=85,$(".content-left").css("height",i+"px"),$(".log-wrap").css("height",s+"px")):(e>t&&(e=t),$(".task-detail").css("width",e),$(".content-left").css("height",i+"px"),$(".log-wrap").css("height",s+"px"))}}}},f66c:function(t,e,i){"use strict";i.r(e);var s=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"member-menu"},[i("a-spin",{attrs:{spinning:t.listLoading||t.doListLoading}},[i("div",{staticClass:"search-content"},[i("a-input",{attrs:{size:"large",placeholder:"搜索"},model:{value:t.keyword,callback:function(e){t.keyword=e},expression:"keyword"}},[i("a-icon",{attrs:{slot:"prefix",type:"search"},slot:"prefix"})],1)],1),i("div",{staticClass:"member-list"},[i("vue-scroll",[i("div",{directives:[{name:"show",rawName:"v-show",value:!t.keyword,expression:"!keyword"}],staticClass:"list-group"},[i("span",{staticClass:"title muted"},[t._v("执行者")]),t.doList.length||t.doListLoading?t._e():i("div",{staticClass:"member-list-item ant-list-item",on:{click:function(e){return t.assignTask(null)}}},[i("div",{staticClass:"ant-list-item-meta"},[i("div",{staticClass:"ant-list-item-meta-avatar"},[i("a-avatar",{attrs:{icon:"user"}})],1),i("div",{staticClass:"ant-list-item-meta-content"},[i("h4",{staticClass:"ant-list-item-meta-title"},[i("span",[t._v("待认领")])])])]),i("ul",{staticClass:"ant-list-item-action"},[i("li",[i("span",[i("a-icon",{attrs:{type:"check"}})],1)])])]),i("a-list",{directives:[{name:"show",rawName:"v-show",value:t.doList.length,expression:"doList.length"}],staticClass:"list-content",attrs:{itemLayout:"horizontal",dataSource:t.doList},scopedSlots:t._u([{key:"renderItem",fn:function(e){return i("a-list-item",{staticClass:"member-list-item"},[i("span",{attrs:{slot:"actions"},slot:"actions"},[i("a-icon",{directives:[{name:"show",rawName:"v-show",value:t.showCheck(e),expression:"showCheck(item)"}],attrs:{type:"check"}})],1),i("a-list-item-meta",[i("span",{attrs:{slot:"title"},slot:"title"},[t._v(t._s(e.name))]),i("a-avatar",{attrs:{slot:"avatar",icon:"user",src:e.avatar},slot:"avatar"})],1)],1)}}])})],1),i("div",{staticClass:"list-group"},[i("span",{staticClass:"title muted"},[t._v("其他成员")]),t.doList.length?i("div",{staticClass:"member-list-item ant-list-item",on:{click:function(e){return t.assignTask(null)}}},[i("div",{staticClass:"ant-list-item-meta"},[i("div",{staticClass:"ant-list-item-meta-avatar"},[i("a-avatar",{attrs:{icon:"user"}})],1),i("div",{staticClass:"ant-list-item-meta-content"},[i("h4",{staticClass:"ant-list-item-meta-title"},[i("span",[t._v("待认领")])])])])]):t._e(),i("a-list",{staticClass:"list-content",attrs:{itemLayout:"horizontal",dataSource:t.list,locale:{emptyText:t.keyword&&t.keyword.length>1?"该成员不在任务成员列表中，你可以邀请他进来":""}},scopedSlots:t._u([{key:"renderItem",fn:function(e){return t.showMember(e)?i("a-list-item",{staticClass:"member-list-item",nativeOn:{click:function(i){return t.assignTask(e.code,e)}}},[i("a-list-item-meta",[i("span",{attrs:{slot:"title"},slot:"title"},[t._v(t._s(e.name))]),i("a-avatar",{attrs:{slot:"avatar",icon:"user",src:e.avatar},slot:"avatar"})],1)],1):t._e()}}],null,!0)})],1)])],1),i("div",{staticClass:"footer"},[i("a-button",{attrs:{type:"primary",size:"large",block:""},on:{click:t.inviteProjectMember}},[t._v("邀请新成员")])],1)])],1)},n=[],o=(i("7f7f"),i("ac6a"),i("386d"),i("c5f6"),i("2ef0")),a=i.n(o),r=i("c030"),c=i("c995"),d=i("ca8d"),l={name:"taskMemberMenu",props:{projectCode:{type:[String,Number],default:function(){return""}},taskCode:{type:[String,Number],default:function(){return""}},isCommit:{type:[Boolean],default:function(){return!0}}},data:function(){return{keyword:"",searching:!1,doListLoading:!1,listLoading:!1,showInviteMember:!1,doList:[],list:[],listTemp:[]}},created:function(){this.init()},watch:{keyword:function(){this.search()}},methods:{init:function(){var t=this;this.projectCode&&(this.listLoading=!0,Object(r["c"])({projectCode:this.projectCode,pageSize:300}).then((function(e){t.list=e.data.list,t.listTemp=e.data.list,t.listLoading=!1}))),this.taskCode&&(this.doListLoading=!0,Object(c["a"])({taskCode:this.taskCode,pageSize:300}).then((function(e){t.doList=e.data.list.filter((function(t){return t.is_executor})),t.doListLoading=!1})))},showMember:function(t){var e=!0;return this.doList.forEach((function(i){t.code==i.code&&(e=!1)})),e},showCheck:function(t){if(t.is_executor)return!0},assignTask:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.isCommit?Object(d["b"])({taskCode:this.taskCode,executorCode:t}).then((function(){e.$emit("close",i)})):this.$emit("close",i)},inviteProjectMember:function(){this.$emit("inviteProjectMember")},search:a.a.debounce((function(){var t=this;if(this.keyword=this.keyword.trim(),this.keyword||(this.list=JSON.parse(JSON.stringify(this.listTemp))),this.keyword.length<=1)return!1;this.searching=!0,this.list=this.list.filter((function(e){return-1!=e.name.indexOf(t.keyword)}))}),500)}},h=l,u=i("2877"),m=Object(u["a"])(h,s,n,!1,null,null,null);e["default"]=m.exports}}]);